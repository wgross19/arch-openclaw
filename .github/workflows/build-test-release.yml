name: build-test-release

on:
  pull_request:
  push:
    branches:
      - main
    paths:
      - ".openclaw-ref"
    tags:
      - "v*-r*"
  workflow_dispatch:
    inputs:
      openclaw_ref:
        description: "Upstream OpenClaw git tag (defaults to .openclaw-ref when empty)"
        required: false
        type: string
      arch_rev:
        description: "Arch release revision (format: rN; default r0)"
        required: false
        default: r0
        type: string
      channel:
        description: "Publish channel"
        required: true
        default: beta
        type: choice
        options:
          - beta
          - stable

permissions:
  contents: write
  packages: write
  security-events: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/openclaw-unraid-cuda

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep jq rsync

      - name: Run contract tests
        run: bash tests/test-contract.sh

      - name: Run migration script tests
        run: bash tests/test-migration-script.sh

  resolve-build-config:
    runs-on: ubuntu-latest
    needs: contract-tests
    outputs:
      openclaw_ref: ${{ steps.resolve.outputs.openclaw_ref }}
      arch_rev: ${{ steps.resolve.outputs.arch_rev }}
      channel: ${{ steps.resolve.outputs.channel }}
      publish: ${{ steps.resolve.outputs.publish }}
      version_tag: ${{ steps.resolve.outputs.version_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve build settings
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          file_ref=""
          if [[ -f .openclaw-ref ]]; then
            file_ref="$(tr -d '[:space:]' < .openclaw-ref)"
          fi

          openclaw_ref="${file_ref}"
          arch_rev="r0"
          channel="beta"
          publish="false"
          version_tag=""

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            input_ref="${{ github.event.inputs.openclaw_ref }}"
            input_arch_rev="${{ github.event.inputs.arch_rev }}"
            if [[ -n "${input_ref}" ]]; then
              openclaw_ref="${input_ref}"
            fi
            if [[ -n "${input_arch_rev}" ]]; then
              arch_rev="${input_arch_rev}"
            fi
            channel="${{ github.event.inputs.channel }}"
            publish="true"
          elif [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            publish="true"
            if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
              tag="${GITHUB_REF_NAME}"
              if [[ "${tag}" =~ ^(.+)-r([0-9]+)$ ]]; then
                openclaw_ref="${BASH_REMATCH[1]}"
                arch_rev="r${BASH_REMATCH[2]}"
              else
                echo "Tag '${tag}' must match format v<openclaw-ref>-rN (example: v2026.2.17-r1)." >&2
                exit 1
              fi
              channel="stable"
            else
              channel="beta"
              arch_rev="r0"
            fi
          fi

          if [[ "${openclaw_ref}" == "SET_ME_TO_OPENCLAW_TAG" ]]; then
            openclaw_ref=""
          fi

          if [[ -z "${openclaw_ref}" && "${publish}" == "true" ]]; then
            echo "openclaw_ref must be set for publish events. Update .openclaw-ref or use workflow_dispatch input." >&2
            exit 1
          fi

          if [[ "${channel}" != "beta" && "${channel}" != "stable" ]]; then
            echo "Unsupported channel: ${channel}" >&2
            exit 1
          fi

          if [[ ! "${arch_rev}" =~ ^r[0-9]+$ ]]; then
            echo "arch_rev must match rN (example: r1)." >&2
            exit 1
          fi

          if [[ "${channel}" == "stable" && "${publish}" == "true" ]]; then
            if [[ -z "${file_ref}" ]]; then
              echo ".openclaw-ref must be set for stable publish events." >&2
              exit 1
            fi
            if [[ "${openclaw_ref}" != "${file_ref}" ]]; then
              echo "Stable release mismatch: tag resolved to '${openclaw_ref}' but .openclaw-ref is '${file_ref}'." >&2
              exit 1
            fi
            version_tag="${openclaw_ref}-cuda13.1-${arch_rev}"
          elif [[ "${publish}" == "true" ]]; then
            version_tag="${openclaw_ref}-cuda13.1-beta"
          fi

          echo "openclaw_ref=${openclaw_ref}" >> "$GITHUB_OUTPUT"
          echo "arch_rev=${arch_rev}" >> "$GITHUB_OUTPUT"
          echo "channel=${channel}" >> "$GITHUB_OUTPUT"
          echo "publish=${publish}" >> "$GITHUB_OUTPUT"
          echo "version_tag=${version_tag}" >> "$GITHUB_OUTPUT"

  build-test-scan:
    runs-on: ubuntu-latest
    needs: resolve-build-config
    if: needs.resolve-build-config.outputs.openclaw_ref != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build local image for tests
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.unraid-cuda
          load: true
          push: false
          tags: local/openclaw-unraid-cuda:test
          build-args: |
            OPENCLAW_REF=${{ needs.resolve-build-config.outputs.openclaw_ref }}

      - name: Run container smoke tests
        run: bash tests/smoke-container.sh local/openclaw-unraid-cuda:test

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: local/openclaw-unraid-cuda:test
          format: table
          exit-code: 1
          ignore-unfixed: true
          severity: CRITICAL,HIGH

  publish:
    runs-on: ubuntu-latest
    needs:
      - resolve-build-config
      - build-test-scan
    if: needs.resolve-build-config.outputs.publish == 'true' && needs.resolve-build-config.outputs.openclaw_ref != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail
          channel="${{ needs.resolve-build-config.outputs.channel }}"
          version_tag="${{ needs.resolve-build-config.outputs.version_tag }}"
          sha_tag="sha-${GITHUB_SHA}"

          {
            echo "tags<<TAGS"
            echo "${IMAGE_NAME}:${version_tag}"
            echo "${IMAGE_NAME}:${sha_tag}"
            echo "${IMAGE_NAME}:${channel}"
            if [[ "${channel}" == "stable" ]]; then
              echo "${IMAGE_NAME}:stable"
            fi
            echo "TAGS"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push release image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.unraid-cuda
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            OPENCLAW_REF=${{ needs.resolve-build-config.outputs.openclaw_ref }}
          provenance: true
          sbom: true

      - name: Update Unraid template defaults for this publish
        id: update-template
        shell: bash
        run: |
          set -euo pipefail
          scripts/update-template-for-release.sh \
            --template templates/openclaw-unraid-cuda.xml \
            --channel "${{ needs.resolve-build-config.outputs.channel }}"

      - name: Commit and push template update
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- templates/openclaw-unraid-cuda.xml; then
            echo "No template changes to commit."
            exit 0
          fi

          git add templates/openclaw-unraid-cuda.xml
          git commit -m "chore(template): auto-update defaults for ${{ needs.resolve-build-config.outputs.channel }} publish"
          git push origin HEAD:main

      - name: Generate release notes draft
        run: |
          bash scripts/release-notes.sh \
            "${{ needs.resolve-build-config.outputs.openclaw_ref }}" \
            "${IMAGE_NAME}" \
            release-notes.md

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md
